name: Create Beta Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Beta version (e.g., 1.0.0-beta.1)'
        required: true
        type: string
      changelog:
        description: 'What changed in this beta?'
        required: false
        type: string

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  create-beta:
    name: Create Beta Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate version format
      run: |
        if [[ ! "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(beta|alpha|rc)\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format. Use: X.Y.Z-beta.N (e.g., 1.0.0-beta.1)"
          exit 1
        fi
        echo "âœ… Version format is valid: ${{ github.event.inputs.version }}"

    - name: Check if tag exists
      run: |
        if git tag | grep -q "^v${{ github.event.inputs.version }}$"; then
          echo "âŒ Tag v${{ github.event.inputs.version }} already exists"
          exit 1
        fi
        echo "âœ… Tag v${{ github.event.inputs.version }} is available"

    - name: Create and push tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${{ github.event.inputs.version }}" -m "Beta Release v${{ github.event.inputs.version }}"
        git push origin "v${{ github.event.inputs.version }}"

    - name: Trigger release workflow
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'release.yml',
            ref: 'v${{ github.event.inputs.version }}',
            inputs: {
              tag: 'v${{ github.event.inputs.version }}'
            }
          });
          
          console.log('ğŸš€ Release workflow triggered for v${{ github.event.inputs.version }}');
          console.log('ğŸ“¦ Check the Actions tab for build progress');
          console.log('ğŸ‰ Beta release will be available shortly!');
